<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>ERLC Staff Portal - SHR & Staff Info</title>
  <style>
    :root {
      --primary: #ffffff;
      --secondary: #f4f6f8;
      --accent: #2563eb;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
    }

    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--secondary);
      color: var(--text);
    }

    .container {
      max-width: 1100px;
      margin: 40px auto;
      background: var(--primary);
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      padding: 30px;
    }

    h1, h2, h3 { margin-top: 0; }
    .hidden { display: none; }

    input, textarea, select, button {
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid var(--border);
      width: 100%;
      box-sizing: border-box;
    }

    textarea { resize: vertical; }

    button {
      background: var(--accent);
      color: white;
      cursor: pointer;
      border: none;
    }

    button.secondary { background: #6b7280; }
    button:hover { opacity: 0.9; }

    .login-box {
      max-width: 320px;
      margin: 100px auto;
      text-align: center;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th { color: var(--muted); font-size: 12px; }

    .note {
      background: #f9fafb;
      border-left: 4px solid var(--accent);
      padding: 10px;
      margin-bottom: 10px;
      font-size: 14px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login" class="login-box">
  <h1>ERLC Staff Portal</h1>
  <p>Enter PIN for SHR access, or leave blank for Staff info</p>
  <input id="pin" type="password" placeholder="Enter PIN (SHR only)" />
  <br /><br />
  <button id="loginBtn">Login</button>
  <p id="error" style="color:red;"></p>
</div>

<!-- SHR PORTAL -->
<div id="shrPortal" class="container hidden">
  <h1>ERLC Staff Portal - SHR Access</h1>
  <p>Access Level: <strong>Senior High Rank (SHR)</strong></p>

  <div class="grid">
    <div class="card">
      <h2>Staff Roster</h2>
      <table id="staffTable"></table>
    </div>

    <div class="card" id="editSection">
      <h2>Add / Edit Staff</h2>
      <input id="sName" placeholder="Name" />
      <input id="sRank" placeholder="Rank" />
      <input id="sDept" placeholder="Department" />
      <br /><br />
      <button id="saveStaffBtn">Save Staff</button>
    </div>

    <div class="card">
      <h2>Staff Notes</h2>
      <select id="noteStaff"></select>
      <br /><br />
      <textarea id="noteText" rows="4" placeholder="Internal staff note (immutable)"></textarea>
      <br /><br />
      <button id="addNoteBtn">Add Note</button>
      <hr />
      <div id="notes"></div>
    </div>
  </div>

  <br />
  <button class="secondary" id="logoutBtnSHR">Logout</button>
</div>

<!-- STAFF INFO PAGE -->
<div id="staffInfo" class="container hidden">
  <h1>ERLC Staff Portal - Staff Info</h1>
  <p>Welcome Staff! Here is your info to help you moderate and support the game.</p>

  <div class="card">
    <h2>Moderation Guidelines</h2>
    <ul>
      <li>Be respectful and professional at all times.</li>
      <li>Follow all ERLC server rules and policies.</li>
      <li>Use moderation commands responsibly.</li>
      <li>Report any issues to SHR staff promptly.</li>
    </ul>
  </div>

  <div class="card">
    <h2>Game Messages & Announcements</h2>
    <ul>
      <li>Daily roll call at 8 AM server time.</li>
      <li>Event announcements will be posted here.</li>
      <li>Use #staff-chat for all internal communication.</li>
    </ul>
  </div>

  <div class="card">
    <h2>Helpful Resources</h2>
    <ul>
      <li><a href="https://erlc.example.com/rules" target="_blank" rel="noopener">Server Rules</a></li>
      <li><a href="https://erlc.example.com/mod-tools" target="_blank" rel="noopener">Moderator Tools Guide</a></li>
      <li><a href="https://erlc.example.com/contacts" target="_blank" rel="noopener">Staff Contacts</a></li>
    </ul>
  </div>

  <br />
  <button class="secondary" id="logoutBtnStaff">Logout</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    onSnapshot,
    query,
    orderBy,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyA5s6vN8eoHkRVhYf_D-MXHpIthmaQEzCc",
    authDomain: "msrp-staff-portal.firebaseapp.com",
    projectId: "msrp-staff-portal",
    storageBucket: "msrp-staff-portal.appspot.com",
    messagingSenderId: "876277274870",
    appId: "1:876277274870:web:41718250817b0bbf9c74d7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const SHR_PIN = "3884";

  // Elements
  const loginDiv = document.getElementById("login");
  const shrPortalDiv = document.getElementById("shrPortal");
  const staffInfoDiv = document.getElementById("staffInfo");
  const errorP = document.getElementById("error");

  // SHR Portal elements
  const staffTable = document.getElementById("staffTable");
  const noteStaffSelect = document.getElementById("noteStaff");
  const notesDiv = document.getElementById("notes");

  const sNameInput = document.getElementById("sName");
  const sRankInput = document.getElementById("sRank");
  const sDeptInput = document.getElementById("sDept");
  const noteTextInput = document.getElementById("noteText");

  const saveStaffBtn = document.getElementById("saveStaffBtn");
  const addNoteBtn = document.getElementById("addNoteBtn");

  // Login handler
  document.getElementById("loginBtn").addEventListener("click", () => {
    const pin = document.getElementById("pin").value.trim();
    if (pin === SHR_PIN) {
      // Show SHR portal
      loginDiv.classList.add("hidden");
      shrPortalDiv.classList.remove("hidden");
      errorP.textContent = "";
      listenStaff();
    } else if (pin === "") {
      // Show Staff Info page
      loginDiv.classList.add("hidden");
      staffInfoDiv.classList.remove("hidden");
      errorP.textContent = "";
    } else {
      errorP.textContent = "Invalid PIN";
    }
  });

  // Logout handlers
  document.getElementById("logoutBtnSHR").addEventListener("click", () => {
    location.reload();
  });
  document.getElementById("logoutBtnStaff").addEventListener("click", () => {
    location.reload();
  });

  // Listen to staff collection (real-time updates)
  function listenStaff() {
    const staffCol = collection(db, "staff");
    onSnapshot(staffCol, (snapshot) => {
      staffTable.innerHTML = "<tr><th>Name</th><th>Rank</th><th>Department</th></tr>";
      noteStaffSelect.innerHTML = "";

      snapshot.forEach((docSnap) => {
        const s = docSnap.data();
        const id = docSnap.id;
        staffTable.innerHTML += `<tr><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.rank)}</td><td>${escapeHtml(s.dept)}</td></tr>`;
        noteStaffSelect.innerHTML += `<option value="${id}">${escapeHtml(s.name)}</option>`;
      });

      if (noteStaffSelect.options.length > 0) {
        noteStaffSelect.selectedIndex = 0;
        loadNotes();
      } else {
        notesDiv.innerHTML = "<em>No staff selected</em>";
      }
    });
  }

  // Save or update staff (only SHR)
  saveStaffBtn.addEventListener("click", async () => {
    const name = sNameInput.value.trim();
    const rank = sRankInput.value.trim();
    const dept = sDeptInput.value.trim();

    if (!name) {
      alert("Name is required");
      return;
    }

    try {
      await setDoc(doc(db, "staff", name), { name, rank, dept });
      sNameInput.value = "";
      sRankInput.value = "";
      sDeptInput.value = "";
    } catch (error) {
      alert("Error saving staff: " + error.message);
    }
  });

  // Load notes for selected staff
  noteStaffSelect.addEventListener("change", loadNotes);

  // Listen notes real-time (detach old listener)
  let notesUnsub = null;

  function loadNotes() {
    if (notesUnsub) notesUnsub();

    const staffId = noteStaffSelect.value;
    if (!staffId) {
      notesDiv.innerHTML = "<em>Select a staff member to see notes</em>";
      return;
    }

    const notesCol = collection(db, "notes", staffId, "entries");
    const q = query(notesCol, orderBy("timestamp", "desc"));

    notesUnsub = onSnapshot(q, (snapshot) => {
      notesDiv.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const n = docSnap.data();
        const timeStr = n.timestamp ? new Date(n.timestamp.seconds * 1000).toLocaleString() : "Loading...";
        notesDiv.innerHTML += `<div class="note"><strong>${escapeHtml(timeStr)}</strong><br>${escapeHtml(n.text)}</div>`;
      });
    });
  }

  // Add new note (only SHR)
  addNoteBtn.addEventListener("click", async () => {
    const staffId = noteStaffSelect.value;
    const text = noteTextInput.value.trim();

    if (!staffId) {
      alert("Please select a staff member");
      return;
    }
    if (!text) {
      alert("Note text cannot be empty");
      return;
    }

    try {
      const notesCol = collection(db, "notes", staffId, "entries");
      await addDoc(notesCol, {
        text,
        timestamp: serverTimestamp()
      });
      noteTextInput.value = "";
    } catch (error) {
      alert("Error adding note: " + error.message);
    }
  });

  // Escape HTML helper
  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>
</body>
</html>
