<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Hospital Chart System</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body { font-family: system-ui; background:#eef2f7; margin:0; padding:20px; }
  h1 { margin-bottom: 10px; }
  .card {
    background:#fff;
    padding:16px;
    border-radius:14px;
    margin-bottom:16px;
    box-shadow:0 4px 12px rgba(0,0,0,.08);
  }
  .row {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:10px;
    margin-bottom:10px;
  }
  input, textarea, select {
    width:100%;
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
  }
  textarea { min-height:70px; }
  button {
    padding:8px 12px;
    border:none;
    border-radius:8px;
    background:#2563eb;
    color:white;
    cursor:pointer;
    margin-right:6px;
  }
  button.gray { background:#6b7280; }
  button.red { background:#dc2626; }
  .chart {
    border-left:4px solid #2563eb;
    padding-left:10px;
    margin-bottom:8px;
    cursor:pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .chart-info {
    flex-grow: 1;
  }
  .badge {
    display:inline-block;
    background:#16a34a;
    color:white;
    padding:2px 6px;
    border-radius:6px;
    font-size:12px;
    margin-left:6px;
  }

  /* Notification styles */
  #notificationContainer {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 320px;
  }
  .notification {
    background: #dc2626;
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    font-weight: 600;
    animation: slideIn 0.3s ease forwards;
    cursor: pointer;
  }
  .notification:hover {
    opacity: 0.9;
  }
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Code Alert Overlay */
  #codeAlertOverlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right:0; bottom:0;
    background: rgba(0,0,0,0.7);
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }
  #codeAlertBox {
    background: white;
    border-radius: 16px;
    padding: 40px 60px;
    text-align: center;
    font-size: 3rem;
    font-weight: 700;
    color: white;
    min-width: 320px;
    cursor: pointer;
    user-select: none;
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
  }

  /* Code Colors */
  .code-red { background: #dc2626; }
  .code-blue { background: #2563eb; }
  .code-black { background: #111; }
  .code-yellow { background: #facc15; color: black; }
  .code-green { background: #16a34a; }
</style>
</head>

<body>

<h1>Hospital Chart System</h1>

<!-- NOTIFICATION MESSAGE INPUT -->
<div class="card">
  <h2>Send Notification</h2>
  <div class="row" style="grid-template-columns: 1fr auto;">
    <input id="notifInput" placeholder="Type notification message here..." />
    <button id="btnSendNotif">Send</button>
  </div>
</div>

<!-- CODE ALERT SYSTEM -->
<div class="card">
  <h2>Send Code Alert</h2>
  <div class="row" style="grid-template-columns: 1fr 1fr auto;">
    <select id="codeSelect" aria-label="Select code color">
      <option value="">-- Select Code --</option>
      <option value="red">Code Red</option>
      <option value="blue">Code Blue</option>
      <option value="black">Code Black</option>
      <option value="yellow">Code Yellow</option>
      <option value="green">Code Green</option>
    </select>
    <input id="roomNumber" placeholder="Room Number" aria-label="Enter room number" />
    <button id="btnSendCode">Alert</button>
  </div>
</div>

<!-- BUILDING STATUS -->
<div class="card">
  <h2>Building Status</h2>
  <button id="btnOpen">Open</button>
  <button id="btnClosed" class="gray">Closed</button>
  <button id="btnLockdown" class="red">Lockdown</button>
  <p>Status: <b id="statusText"></b></p>
</div>

<!-- CLOCK IN / OUT -->
<div class="card">
  <h2>Staff Clock</h2>
  <div class="row">
    <input id="staffName" placeholder="Staff Full Name" />
    <button id="btnToggleClock">Clock In / Out</button>
  </div>
  <p><b>Currently Clocked In:</b></p>
  <ul id="clockedList"></ul>
</div>

<!-- PATIENT CHARTS -->
<div class="card">
  <h2>Patient Charts</h2>
  <button id="btnNewChart">New Chart</button>
  <div id="chartList"></div>
</div>

<!-- CHART EDITOR -->
<div class="card" id="editor" style="display:none">
  <h2>Active Chart</h2>

  <div class="row">
    <input id="name" placeholder="Patient Full Name" />
    <input id="mrn" placeholder="Medical Record Number (MRN)" />
    <input id="dob" type="date" />
  </div>

  <div class="row">
    <input id="bp" placeholder="Blood Pressure (e.g., 120/80 mmHg)" />
    <input id="hr" placeholder="Heart Rate (beats per minute)" />
    <input id="rr" placeholder="Respiratory Rate (breaths per minute)" />
    <input id="spo2" placeholder="Oxygen Saturation (SpO₂ %)" />
  </div>

  <textarea id="complaint" placeholder="Chief Complaint (Reason for Visit)"></textarea>
  <textarea id="assessment" placeholder="Assessment (Diagnosis and Findings)"></textarea>
  <textarea id="plan" placeholder="Plan / Orders (Treatment and Instructions)"></textarea>
</div>

<!-- Notification container -->
<div id="notificationContainer"></div>

<!-- Code Alert Overlay -->
<div id="codeAlertOverlay">
  <div id="codeAlertBox"></div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Broadcast Channel for cross-tab sync ---
    const bc = new BroadcastChannel("hospital-system");

    // --- NOTIFICATION SYSTEM ---
    const notifInput = document.getElementById("notifInput");
    const btnSendNotif = document.getElementById("btnSendNotif");
    const notificationContainer = document.getElementById("notificationContainer");

    function createNotification(message) {
      const notif = document.createElement("div");
      notif.className = "notification";
      notif.textContent = message;

      notif.addEventListener("click", () => {
        notificationContainer.removeChild(notif);
      });

      notificationContainer.appendChild(notif);

      setTimeout(() => {
        if (notificationContainer.contains(notif)) {
          notificationContainer.removeChild(notif);
        }
      }, 5000);
    }

    btnSendNotif.addEventListener("click", () => {
      const message = notifInput.value.trim();
      if (!message) {
        alert("Please type a notification message first.");
        return;
      }
      // Send to other tabs
      bc.postMessage({type: "notification", message});
      // Also create locally
      createNotification(message);
      notifInput.value = "";
    });

    notifInput.addEventListener("keypress", e => {
      if (e.key === "Enter") {
        btnSendNotif.click();
      }
    });

    // Listen to BroadcastChannel messages
    bc.onmessage = e => {
      const data = e.data;
      if (data.type === "notification") {
        createNotification(data.message);
      }
      else if (data.type === "codeAlert") {
        showCodeAlert(data.code, data.room, false);
      }
      else if (data.type === "buildingStatus") {
        setStatus(data.status, false);
      }
      else if (data.type === "clockInOut") {
        clockedIn = data.clockedIn;
        saveClock();
        renderClock();
      }
      else if (data.type === "chartsUpdate") {
        charts = data.charts;
        saveCharts();
        renderCharts();
        // If active chart closed, hide editor
        if (!charts.find(c => c.id === activeId)) {
          activeId = null;
          editor.style.display = "none";
        }
      }
    };

    // --- CODE ALERT SYSTEM ---
    const codeSelect = document.getElementById("codeSelect");
    const roomNumberInput = document.getElementById("roomNumber");
    const btnSendCode = document.getElementById("btnSendCode");
    const codeAlertOverlay = document.getElementById("codeAlertOverlay");
    const codeAlertBox = document.getElementById("codeAlertBox");

    function showCodeAlert(code, room, broadcast=true) {
      if (!code) return alert("Please select a code.");
      if (!room) return alert("Please enter a room number.");

      const codeName = code.charAt(0).toUpperCase() + code.slice(1);
      codeAlertBox.textContent = `${codeName} Code - Room ${room}`;

      codeAlertBox.className = "";
      switch (code) {
        case "red":
          codeAlertBox.classList.add("code-red");
          break;
        case "blue":
          codeAlertBox.classList.add("code-blue");
          break;
        case "black":
          codeAlertBox.classList.add("code-black");
          break;
        case "yellow":
          codeAlertBox.classList.add("code-yellow");
          break;
        case "green":
          codeAlertBox.classList.add("code-green");
          break;
        default:
          codeAlertBox.style.background = "#444";
          codeAlertBox.style.color = "white";
      }

      codeAlertOverlay.style.display = "flex";

      // Broadcast to other tabs if requested
      if(broadcast) {
        bc.postMessage({type:"codeAlert", code, room});
      }
    }

    btnSendCode.addEventListener("click", () => {
      const selectedCode = codeSelect.value;
      const roomNumber = roomNumberInput.value.trim();
      showCodeAlert(selectedCode, roomNumber);
    });

    codeAlertOverlay.addEventListener("click", () => {
      codeAlertOverlay.style.display = "none";
    });

    // --- BUILDING STATUS ---
    let buildingStatus = localStorage.getItem("buildingStatus") || "Open";
    const statusText = document.getElementById("statusText");
    statusText.textContent = buildingStatus;

    function setStatus(s, broadcast=true) {
      buildingStatus = s;
      localStorage.setItem("buildingStatus", s);
      statusText.textContent = s;
      if (broadcast) bc.postMessage({type:"buildingStatus", status: s});
    }

    document.getElementById("btnOpen").addEventListener("click", () => setStatus("Open"));
    document.getElementById("btnClosed").addEventListener("click", () => setStatus("Closed"));
    document.getElementById("btnLockdown").addEventListener("click", () => setStatus("Lockdown"));

    // --- CLOCK IN / OUT ---
    let clockedIn = JSON.parse(localStorage.getItem("clockedIn") || "[]");

    const clockedList = document.getElementById("clockedList");
    const staffNameInput = document.getElementById("staffName");

    function saveClock() {
      localStorage.setItem("clockedIn", JSON.stringify(clockedIn));
    }

    function renderClock() {
      clockedList.innerHTML = "";
      clockedIn.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        const badge = document.createElement("span");
        badge.textContent = "ON DUTY";
        badge.className = "badge";
        li.appendChild(badge);
        clockedList.appendChild(li);
      });
    }

    function toggleClock() {
      const name = staffNameInput.value.trim();
      if (!name) {
        alert("Please enter your staff full name");
        return;
      }
      if (clockedIn.includes(name)) {
        clockedIn = clockedIn.filter(n => n !== name);
      } else {
        clockedIn.push(name);
      }
      saveClock();
      renderClock();
      staffNameInput.value = "";
      // Broadcast updated clock state
      bc.postMessage({type:"clockInOut", clockedIn});
    }

    document.getElementById("btnToggleClock").addEventListener("click", toggleClock);

    renderClock();

    // --- PATIENT CHARTS ---
    let charts = JSON.parse(localStorage.getItem("charts") || "[]");
    let activeId = null;

    const chartList = document.getElementById("chartList");
    const editor = document.getElementById("editor");

    function saveCharts() {
      localStorage.setItem("charts", JSON.stringify(charts));
    }

    function renderCharts() {
      chartList.innerHTML = "";
      charts.forEach(c => {
        const div = document.createElement("div");
        div.className = "chart";

        const info = document.createElement("div");
        info.className = "chart-info";
        info.innerHTML = `<b>${c.name || "Unnamed Patient"}</b><br>Medical Record Number: ${c.mrn || "—"}`;
        info.onclick = () => openChart(c.id);
        info.style.cursor = "pointer";

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "red";
        delBtn.onclick = (e) => {
          e.stopPropagation();
          if(confirm(`Delete chart for "${c.name || "Unnamed Patient"}"?`)) {
            charts = charts.filter(chart => chart.id !== c.id);
            saveCharts();
            // Broadcast update
            bc.postMessage({type:"chartsUpdate", charts});
            if(activeId === c.id) {
              activeId = null;
              editor.style.display = "none";
            }
            renderCharts();
          }
        };

        div.appendChild(info);
        div.appendChild(delBtn);

        chartList.appendChild(div);
      });
    }

    function newChart() {
      const chart = {
        id: Date.now(),
        name:"", mrn:"", dob:"",
        bp:"", hr:"", rr:"", spo2:"",
        complaint:"", assessment:"", plan:""
      };
      charts.push(chart);
      saveCharts();
      // Broadcast update
      bc.postMessage({type:"chartsUpdate", charts});
      openChart(chart.id);
      renderCharts();
    }

    function openChart(id) {
      activeId = id;
      const c = charts.find(x => x.id === id);
      editor.style.display = "block";

      ['name','mrn','dob','bp','hr','rr','spo2','complaint','assessment','plan'].forEach(field => {
        const el = document.getElementById(field);
        if (!el) return;
        el.value = c[field];
        el.oninput = e => {
          c[field] = e.target.value;
          saveCharts();
          // Broadcast update on every input (could throttle if needed)
          bc.postMessage({type:"chartsUpdate", charts});
          renderCharts();
        };
      });
    }

    document.getElementById("btnNewChart").addEventListener("click", newChart);

    renderCharts();
  });
</script>

</body>
</html>
