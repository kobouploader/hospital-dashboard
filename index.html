<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ERLC Staff Portal - Modular Firebase</title>
  <style>
    :root {
      --primary: #ffffff;
      --secondary: #f4f6f8;
      --accent: #2563eb;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
    }

    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--secondary);
      color: var(--text);
    }

    .container {
      max-width: 1100px;
      margin: 40px auto;
      background: var(--primary);
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      padding: 30px;
    }

    h1, h2, h3 { margin-top: 0; }
    .hidden { display: none; }

    input, textarea, select, button {
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid var(--border);
      width: 100%;
      box-sizing: border-box;
    }

    textarea { resize: vertical; }

    button {
      background: var(--accent);
      color: white;
      cursor: pointer;
      border: none;
    }

    button.secondary { background: #6b7280; }
    button:hover { opacity: 0.9; }

    .login-box {
      max-width: 320px;
      margin: 100px auto;
      text-align: center;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      background: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th { color: var(--muted); font-size: 12px; }

    .note {
      background: #f9fafb;
      border-left: 4px solid var(--accent);
      padding: 10px;
      margin-bottom: 10px;
      font-size: 14px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login" class="login-box">
  <h1>ERLC Staff Portal</h1>
  <p>SHR Secure Login</p>
  <input id="pin" type="password" placeholder="Enter PIN" />
  <br><br>
  <button id="loginBtn">Login</button>
  <p id="error" style="color:red;"></p>
</div>

<!-- PORTAL -->
<div id="portal" class="container hidden">
  <h1>ERLC Staff Portal</h1>
  <p>Access Level: <strong>Senior High Rank (SHR)</strong></p>

  <div class="grid">
    <div class="card">
      <h2>Staff Roster</h2>
      <table id="staffTable"></table>
      <br>
      <h3>Add / Edit Staff</h3>
      <input id="sName" placeholder="Name" />
      <input id="sRank" placeholder="Rank" />
      <input id="sDept" placeholder="Department" />
      <br><br>
      <button id="saveStaffBtn">Save Staff</button>
    </div>

    <div class="card">
      <h2>Staff Notes</h2>
      <select id="noteStaff"></select>
      <br><br>
      <textarea id="noteText" rows="4" placeholder="Internal staff note (immutable)"></textarea>
      <br><br>
      <button id="addNoteBtn">Add Note</button>
      <hr />
      <div id="notes"></div>
    </div>
  </div>

  <br />
  <button class="secondary" id="logoutBtn">Logout</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    onSnapshot,
    query,
    orderBy,
    addDoc,
    serverTimestamp,
    getDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA5s6vN8eoHkRVhYf_D-MXHpIthmaQEzCc",
    authDomain: "msrp-staff-portal.firebaseapp.com",
    projectId: "msrp-staff-portal",
    storageBucket: "msrp-staff-portal.appspot.com",
    messagingSenderId: "876277274870",
    appId: "1:876277274870:web:41718250817b0bbf9c74d7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const SHR_PIN = "3884";

  const loginDiv = document.getElementById("login");
  const portalDiv = document.getElementById("portal");
  const errorP = document.getElementById("error");

  const staffTable = document.getElementById("staffTable");
  const noteStaffSelect = document.getElementById("noteStaff");
  const notesDiv = document.getElementById("notes");

  const sNameInput = document.getElementById("sName");
  const sRankInput = document.getElementById("sRank");
  const sDeptInput = document.getElementById("sDept");
  const noteTextInput = document.getElementById("noteText");

  // Login
  document.getElementById("loginBtn").addEventListener("click", () => {
    const pin = document.getElementById("pin").value;
    if (pin === SHR_PIN) {
      loginDiv.classList.add("hidden");
      portalDiv.classList.remove("hidden");
      listenStaff();
    } else {
      errorP.textContent = "Invalid PIN";
    }
  });

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    location.reload();
  });

  // Listen to staff collection and update UI
  function listenStaff() {
    const staffCol = collection(db, "staff");
    onSnapshot(staffCol, (snapshot) => {
      staffTable.innerHTML = "<tr><th>Name</th><th>Rank</th><th>Department</th></tr>";
      noteStaffSelect.innerHTML = "";

      snapshot.forEach((docSnap) => {
        const s = docSnap.data();
        const id = docSnap.id;
        staffTable.innerHTML += `<tr><td>${s.name}</td><td>${s.rank}</td><td>${s.dept}</td></tr>`;
        noteStaffSelect.innerHTML += `<option value="${id}">${s.name}</option>`;
      });

      loadNotes();
    });
  }

  // Save or update staff
  document.getElementById("saveStaffBtn").addEventListener("click", async () => {
    const name = sNameInput.value.trim();
    const rank = sRankInput.value.trim();
    const dept = sDeptInput.value.trim();

    if (!name) {
      alert("Name is required");
      return;
    }

    const staffDoc = doc(db, "staff", name);
    await setDoc(staffDoc, { name, rank, dept });
    sNameInput.value = "";
    sRankInput.value = "";
    sDeptInput.value = "";
  });

  // Load notes for selected staff
  noteStaffSelect.addEventListener("change", loadNotes);

  async function loadNotes() {
    const staffId = noteStaffSelect.value;
    if (!staffId) {
      notesDiv.innerHTML = "<em>Select a staff member to see notes</em>";
      return;
    }

    const notesCol = collection(db, "notes", staffId, "entries");
    const q = query(notesCol, orderBy("timestamp", "desc"));

    // Detach previous listeners to avoid duplication is a more advanced topic
    // For simplicity, here we attach a new listener every time
    onSnapshot(q, (snapshot) => {
      notesDiv.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const n = docSnap.data();
        const timeStr = n.timestamp ? new Date(n.timestamp.seconds * 1000).toLocaleString() : "Loading...";
        notesDiv.innerHTML += `<div class="note"><strong>${timeStr}</strong><br>${escapeHtml(n.text)}</div>`;
      });
    });
  }

  // Add new note
  document.getElementById("addNoteBtn").addEventListener("click", async () => {
    const staffId = noteStaffSelect.value;
    const text = noteTextInput.value.trim();
    if (!staffId) {
      alert("Please select a staff member");
      return;
    }
    if (!text) {
      alert("Note text cannot be empty");
      return;
    }

    const notesCol = collection(db, "notes", staffId, "entries");
    await addDoc(notesCol, {
      text,
      timestamp: serverTimestamp()
    });

    noteTextInput.value = "";
  });

  // Helper: Escape HTML to avoid injection in notes
  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>
</body>
</html>
